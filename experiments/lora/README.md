# Testing LoRA on different light and electron miscroscopy datasets

### Datasets
**gonuclear**: Dataset for nuclei segmentation in 3D fluorescence microscopy (lm)
**orgasegment**: Dataset for the segmentation of human intestinal organoids (lm)  
**covid_if**: Datset that contains annotation for cell and nucleus segmentation in immunofluorescence microscopy(lm)  
**mitolab/glycolytic_muscle**: Dataset for mitochondria segmentation (em)  
**platynereis/cilia**: Dataset for the segmentation of cilia in the platynereis larve. 

## Comparing LoRA with Full Finetuning
On all 5 datasets the SAM model is trained from default and from the micro-sam models using LoRA and full finetuning.  
Note that all datasets except GuNuclear are trained with early stopping while GoNuclear is trained for 50k iterations.

### Orgasegment

|                    |        ais |      amg |   single box |   single point |   iterative_prompts_start_box |   iterative_prompts_start_point |
|:-------------------|-----------:|---------:|-------------:|---------------:|------------------------------:|--------------------------------:|
| generalist         |   0.239504 | 0.313557 |     0.766814 |       0.426106 |                      0.870109 |                        0.813314 |
| specialist_full_ft |   0.51541  | 0.423463 |     0.790572 |       0.556546 |                      0.87495  |                        0.841196 |
| specialist_lora    |   0.478586 | 0.372293 |     0.77696  |       0.510568 |                      0.872069 |                        0.839907 |
| vanilla            | -| 0.343003 |     0.630294 |       0.494892 |                      0.484599 |                        0.475463 |

### Platynereis Cilia


|                    |        ais |        amg |   single box |   single point |   iterative_prompts_start_box |   iterative_prompts_start_point |
|:-------------------|-----------:|-----------:|-------------:|---------------:|------------------------------:|--------------------------------:|
| generalist         |   0        | 0.00875561 |     0.184394 |      0.0593038 |                      0.429399 |                        0.349337 |
| specialist_full_ft |   0.236222 | 0.208035   |     0.371877 |      0.234535  |                      0.524445 |                        0.451413 |
| specialist_lora    |   0.212794 | 0.137063   |     0.369033 |      0.244724  |                      0.51684  |                        0.446328 |
| vanilla            | -| 0.135574   |     0.26555  |      0.175185  |                      0.195464 |                        0.107775 |


### Mitolab Glycolytic Muscle
|                    |        ais |      amg |   single box |   single point |   iterative_prompts_start_box |   iterative_prompts_start_point |
|:-------------------|-----------:|---------:|-------------:|---------------:|------------------------------:|--------------------------------:|
| generalist         |   0.430989 | 0.357421 |     0.791705 |       0.519416 |                      0.931755 |                        0.902345 |
| specialist_full_ft |   0.616114 | 0.552763 |     0.856562 |       0.665076 |                      0.966356 |                        0.946224 |
| specialist_lora    |   0.658877 | 0.53201  |   0.865823|       0.714701 |                    0.9657445       |                        0.945478 |
| vanilla            | -        | 0.150659 |     0.652191 |       0.538324 |                      0.660341 |                        0.56703  |


### CovidIF

|                    |        ais |       amg |   single box |   single point |   iterative_prompts_start_box |   iterative_prompts_start_point |
|:-------------------|-----------:|----------:|-------------:|---------------:|------------------------------:|--------------------------------:|
| generalist         |   0.152222 | 0.0746765 |     0.569341 |      0.156363  |                      0.81381  |                       0.721318  |
| specialist_full_ft |   0.244846 | 0.13918   |     0.619487 |      0.244443  |                      0.825262 |                       0.749033  |
| specialist_lora    |   0.196347 | 0.0357408 |     0.583991 |      0.180315  |                      0.817916 |                       0.725224  |
| vanilla            | - | 0.0529358 |     0.388909 |      0.0424461 |                      0.29122  |                       0.0958208 |



# GoNuclear 

|                    |        ais |       amg |   single box |   single point |   iterative_prompts_start_box |   iterative_prompts_start_point |
|:-------------------|-----------:|----------:|-------------:|---------------:|------------------------------:|--------------------------------:|
| generalist         |    0.0890959 | 0.033125|    0.686063 |      0.167951|                      0.764031  |                       0.686301  |
| specialist_full_ft |   0.105786 | 0.030567   |    0.719985 |      0.244551  |                      0.744716 |                       0.653932  |
| specialist_lora    |   0.204244 |  0.043957 |     0.673355 |     0.268546 |                      0.756035 |                       0.684994  |
| vanilla            | - | -|     0.498223|      0.362247|                      0.439616|                       0.318307 |


## Extended Rank Study on Mitolab Glycolytic Muscle
### Mitolab Glycolytic Muscle

Domain is well known by the generalist model

#### From Default
| name    |      AIS |      AMG |      Box |    Point |
|:--------|---------:|---------:|---------:|---------:|
| vanilla | nan        | 0.150659 | 0.652191 | 0.538324 |
| lora_1  | 0.549484 | 0.507444 | 0.841889 | 0.711415 |
| lora_2  | 0.556883 | 0.490352 | 0.845439 | 0.706573 |
| lora_4  | 0.591906 | 0.489366 | 0.848887 | 0.702615 |
| lora_8  | 0.600346 | 0.476347 | 0.848355 | 0.693523 |
| lora_16 | 0.583292 | 0.471583 | 0.848447 | 0.709279 |
| lora_32 | 0.577014 | 0.505774 | 0.847235 | 0.696355 |
| lora_64 | 0.594854 | 0.531694 | 0.847471 | 0.733067 |
| full_ft | 0.654125 | 0.58816  | 0.844841 | 0.670931 |

#### From Generalist

| name    |      AIS |      AMG |      Box |    Point |
|:--------|---------:|---------:|---------:|---------:|
| generalist | 0.430989 | 0.357421 | 0.791705 | 0.519416 |
| lora_1  | 0.617624 | 0.539184 | 0.86804  | 0.727741 |
| lora_2  | 0.636927 | 0.531309 | 0.866054 | 0.72443  |
| lora_4  | 0.612037 | 0.555217 | 0.865789 | 0.722931 |
| lora_8  | 0.648352 | 0.564039 | 0.863956 | 0.730869 |
| lora_16 | 0.626368 | 0.559474 | 0.865566 | 0.727721 |
| lora_32 | 0.630273 | 0.562193 | 0.865755 | 0.72731  |
| lora_64 | 0.615694 | 0.572311 | 0.865311 | 0.742754 |
| full_ft | 0.681277 | 0.58494  | 0.854074 | 0.688395 |

### Orgasegment

Domain is highly different from domain ‘known’ by the generalist model

#### From Default
| name    |      AIS |      AMG |      Box |    Point |
|:--------|---------:|---------:|---------:|---------:|
| vanilla | nan        | 0.343003 | 0.630294 | 0.494892 |
| lora_1  | 0.414372 | 0.370126 | 0.767285 | 0.531497 |
| lora_2  | 0.426449 | 0.373112 | 0.770356 | 0.540227 |
| lora_4  | 0.429695 | 0.372823 | 0.76679  | 0.536833 |
| lora_8  | 0.418091 | 0.373189 | 0.769579 | 0.551802 |
| lora_16 | 0.419071 | 0.377984 | 0.773225 | 0.559315 |
| lora_32 | 0.421673 | 0.392801 | 0.77536  | 0.56451  |
| lora_64 | 0.431376 | 0.392141 | 0.77401  | 0.581975 |
| full_ft | 0.481982 | 0.450553 | 0.753868 | 0.568104 |


#### From Generalist

| name    |      AIS |      AMG |      Box |    Point |
|:--------|---------:|---------:|---------:|---------:|
| generalist | 0.239504 | 0.313557 | 0.766814 | 0.426106 |
| lora_1  | 0.467328 | 0.384649 | 0.788527 | 0.526489 |
| lora_2  | 0.471765 | 0.39285  | 0.792983 | 0.536056 |
| lora_4  | 0.455499 | 0.393884 | 0.796325 | 0.536955 |
| lora_8  | 0.451356 | 0.394755 | 0.795676 | 0.537157 |
| lora_16 | 0.476082 | 0.409496 | 0.787012 | 0.534475 |
| lora_32 | 0.471721 | 0.402015 | 0.794801 | 0.550029 |
| lora_64 | 0.474701 | 0.400378 | 0.798804 | 0.555428 |
| full_ft    | 0.504257 | 0.428629 | 0.77399  | 0.56243  |


## LoRA Scaling Factor study on OrgaSegment

Run LoRA finetuning with learning rate 1e-5 on Orgasegment, where $r \in [1, 2, 4, 8, 16, 32, 64]$ and $\alpha \in [1, 2, 4]$

|    |   alpha |   rank |      ais |   single box |   single point |       ib |       ip |
|---:|--------:|-------:|---------:|-------------:|---------------:|---------:|---------:|
|  0 |       1 |      1 | 0.46768  |     0.785293 |       0.439386 | 0.86695  | 0.821838 |
|  1 |       1 |      2 | 0.471911 |     0.786374 |       0.433548 | 0.867893 | 0.83224  |
|  2 |       1 |      4 | 0.45655  |     0.786528 |       0.425875 | 0.863859 | 0.836048 |
|  3 |       1 |      8 | 0.457918 |     0.790174 |       0.46141  | 0.86591  | 0.825908 |
|  4 |       1 |     16 | 0.457208 |     0.789676 |       0.466306 | 0.866872 | 0.830449 |
|  5 |       1 |     32 | 0.488162 |     0.782712 |       0.448029 | 0.868277 | 0.837268 |
|  6 |       1 |     64 | 0.466878 |     0.786976 |       0.472517 | 0.871169 | 0.823809 |
|  7 |       2 |      1 | 0.439019 |     0.78005  |       0.384774 | 0.863876 | 0.833593 |
|  8 |       2 |      2 | 0.457357 |     0.775716 |       0.378806 | 0.865322 | 0.822178 |
|  9 |       2 |      4 | 0.460424 |     0.776154 |       0.418577 | 0.864934 | 0.829442 |
| 10 |       2 |      8 | 0.449743 |     0.785188 |       0.407661 | 0.865123 | 0.831398 |
| 11 |       2 |     16 | 0.449357 |     0.783327 |       0.440186 | 0.872503 | 0.827945 |
| 12 |       2 |     32 | 0.448341 |     0.781927 |       0.426363 | 0.867309 | 0.825397 |
| 13 |       2 |     64 | 0.448659 |     0.777635 |       0.416114 | 0.871193 | 0.834761 |
| 14 |       4 |      1 | 0.424588 |     0.774597 |       0.380587 | 0.865883 | 0.82841  |
| 15 |       4 |      2 | 0.429094 |     0.7713   |       0.375386 | 0.867399 | 0.822512 |
| 16 |       4 |      4 | 0.40225  |     0.764904 |       0.389807 | 0.861496 | 0.822226 |
| 17 |       4 |      8 | 0.431113 |     0.762114 |       0.381358 | 0.847661 | 0.816571 |
| 18 |       4 |     16 | 0.392832 |     0.775656 |       0.403179 | 0.860024 | 0.818837 |
| 19 |       4 |     32 | 0.385684 |     0.762713 |       0.38742  | 0.862808 | 0.816105 |
| 20 |       4 |     64 | 0.41263  |     0.761647 |       0.39586  | 0.86177  | 0.811884 |

Run LoRA finetuning on OrgaSegment data with $r \in [1, 32], \alpha \in [1, 2, 4]$ and learning rate $\in [1e-3, 5e-4, 1e-4, 5e-5]$

|     lr |   alpha |   rank |      ais |   single box |   single point |       ib |       ip |
|-------:|--------:|-------:|---------:|-------------:|---------------:|---------:|---------:|
| 0.001  |       1 |      1 | 0.442127 |     0.654549 |      0.449638  | 0.716472 | 0.674504 |
| 0.0005 |       1 |      1 | 0.447397 |     0.685428 |      0.474276  | 0.794246 | 0.755539 |
| 0.0001 |       1 |      1 | 0.454513 |     0.781788 |      0.450372  | 0.854963 | 0.83155  |
| 5e-05  |       1 |      1 | 0.449267 |     0.777703 |      0.429012  | 0.857398 | 0.826365 |
| 0.001  |       1 |     32 | 0.462965 |     0.644866 |      0.447835  | 0.7272   | 0.684349 |
| 0.0005 |       1 |     32 | 0.463994 |     0.71032  |      0.450568  | 0.788229 | 0.761538 |
| 0.0001 |       1 |     32 | 0.450451 |     0.768767 |      0.480264  | 0.856028 | 0.825444 |
| 5e-05  |       1 |     32 | 0.450311 |     0.783481 |      0.451521  | 0.867285 | 0.825451 |
| 0.001  |       2 |      1 | 0.41477  |     0.658934 |      0.445661  | 0.732447 | 0.69444  |
| 0.0005 |       2 |      1 | 0.399873 |     0.710725 |      0.429254  | 0.803367 | 0.771407 |
| 0.0001 |       2 |      1 | 0.407968 |     0.772299 |      0.411129  | 0.862437 | 0.822948 |
| 5e-05  |       2 |      1 | 0.417246 |     0.768827 |      0.422415  | 0.856941 | 0.830253 |
| 0.001  |       2 |     32 | 0.440821 |     0.654136 |      0.43298   | 0.732599 | 0.679426 |
| 0.0005 |       2 |     32 | 0.432974 |     0.701175 |      0.433576  | 0.803707 | 0.767254 |
| 0.0001 |       2 |     32 | 0.422555 |     0.76504  |      0.453462  | 0.854968 | 0.818326 |
| 5e-05  |       2 |     32 | 0.443315 |     0.763643 |      0.431217  | 0.861896 | 0.821367 |
| 0.001  |       4 |      1 | 0.307598 |     0.632471 |      0.395491  | 0.714629 | 0.678695 |
| 0.0005 |       4 |      1 | 0.305425 |     0.692954 |      0.403879  | 0.804363 | 0.760226 |
| 0.0001 |       4 |      1 | 0.329502 |     0.745291 |      0.371818  | 0.848811 | 0.817561 |
| 5e-05  |       4 |      1 | 0.382733 |     0.752421 |      0.368005  | 0.850422 | 0.808273 |
| 0.001  |       4 |     32 | 0.253865 |     0.555627 |      0.0873718 | 0.693467 | 0.549289 |
| 0.0005 |       4 |     32 | 0.386197 |     0.68237  |      0.399336  | 0.786092 | 0.746278 |
| 0.0001 |       4 |     32 | 0.338818 |     0.731417 |      0.394499  | 0.838756 | 0.805187 |
| 5e-05  |       4 |     32 | 0.348358 |     0.74747  |      0.416478  | 0.856479 | 0.815458 |