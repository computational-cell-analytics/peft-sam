# Testing LoRA on different light and electron miscroscopy datasets

### Datasets
**gonuclear**: Dataset for nuclei segmentation in 3D fluorescence microscopy (lm)
**orgasegment**: Dataset for the segmentation of human intestinal organoids (lm)  
**covid_if**: Datset that contains annotation for cell and nucleus segmentation in immunofluorescence microscopy(lm)  
**mitolab/glycolytic_muscle**: Dataset for mitochondria segmentation (em)  
**platynereis/cilia**: Dataset for the segmentation of cilia in the platynereis larve. 

## Comparing LoRA with Full Finetuning
On all 5 datasets the SAM model is trained from default and from the micro-sam models using LoRA and full finetuning.  
Note that all datasets except GuNuclear are trained with early stopping while GoNuclear is trained for 50k iterations.

### Orgasegment

|                    |        ais |      amg |   single box |   single point |   iterative_prompts_start_box |   iterative_prompts_start_point |
|:-------------------|-----------:|---------:|-------------:|---------------:|------------------------------:|--------------------------------:|
| generalist         |   0.239504 | 0.313557 |     0.766814 |       0.426106 |                      0.870109 |                        0.813314 |
| specialist_full_ft |   0.51541  | 0.423463 |     0.790572 |       0.556546 |                      0.87495  |                        0.841196 |
| specialist_lora    |   0.478586 | 0.372293 |     0.77696  |       0.510568 |                      0.872069 |                        0.839907 |
| vanilla            | -| 0.343003 |     0.630294 |       0.494892 |                      0.484599 |                        0.475463 |

### Platynereis Cilia


|                    |        ais |        amg |   single box |   single point |   iterative_prompts_start_box |   iterative_prompts_start_point |
|:-------------------|-----------:|-----------:|-------------:|---------------:|------------------------------:|--------------------------------:|
| generalist         |   0        | 0.00875561 |     0.184394 |      0.0593038 |                      0.429399 |                        0.349337 |
| specialist_full_ft |   0.236222 | 0.208035   |     0.371877 |      0.234535  |                      0.524445 |                        0.451413 |
| specialist_lora    |   0.212794 | 0.137063   |     0.369033 |      0.244724  |                      0.51684  |                        0.446328 |
| vanilla            | -| 0.135574   |     0.26555  |      0.175185  |                      0.195464 |                        0.107775 |


### Mitolab Glycolytic Muscle
|                    |        ais |      amg |   single box |   single point |   iterative_prompts_start_box |   iterative_prompts_start_point |
|:-------------------|-----------:|---------:|-------------:|---------------:|------------------------------:|--------------------------------:|
| generalist         |   0.430989 | 0.357421 |     0.791705 |       0.519416 |                      0.931755 |                        0.902345 |
| specialist_full_ft |   0.616114 | 0.552763 |     0.856562 |       0.665076 |                      0.966356 |                        0.946224 |
| specialist_lora    |   0.658877 | 0.53201  |   0.865823|       0.714701 |                    0.9657445       |                        0.945478 |
| vanilla            | -        | 0.150659 |     0.652191 |       0.538324 |                      0.660341 |                        0.56703  |


### CovidIF

|                    |        ais |       amg |   single box |   single point |   iterative_prompts_start_box |   iterative_prompts_start_point |
|:-------------------|-----------:|----------:|-------------:|---------------:|------------------------------:|--------------------------------:|
| generalist         |   0.152222 | 0.0746765 |     0.569341 |      0.156363  |                      0.81381  |                       0.721318  |
| specialist_full_ft |   0.244846 | 0.13918   |     0.619487 |      0.244443  |                      0.825262 |                       0.749033  |
| specialist_lora    |   0.196347 | 0.0357408 |     0.583991 |      0.180315  |                      0.817916 |                       0.725224  |
| vanilla            | - | 0.0529358 |     0.388909 |      0.0424461 |                      0.29122  |                       0.0958208 |



# GoNuclear 

|                    |        ais |       amg |   single box |   single point |   iterative_prompts_start_box |   iterative_prompts_start_point |
|:-------------------|-----------:|----------:|-------------:|---------------:|------------------------------:|--------------------------------:|
| generalist         |    0.0890959 | 0.033125|    0.686063 |      0.167951|                      0.764031  |                       0.686301  |
| specialist_full_ft |   0.105786 | 0.030567   |    0.719985 |      0.244551  |                      0.744716 |                       0.653932  |
| specialist_lora    |   0.204244 |  0.043957 |     0.673355 |     0.268546 |                      0.756035 |                       0.684994  |
| vanilla            | - | -|     0.498223|      0.362247|                      0.439616|                       0.318307 |


## Extended Rank Study on Mitolab Glycolytic Muscle
### Mitolab Glycolytic Muscle

Domain is well known by the generalist model

#### From Default
| name    |      AIS |      AMG |      Box |    Point |
|:--------|---------:|---------:|---------:|---------:|
| vanilla | nan        | 0.150659 | 0.652191 | 0.538324 |
| lora_1  | 0.549484 | 0.507444 | 0.841889 | 0.711415 |
| lora_2  | 0.556883 | 0.490352 | 0.845439 | 0.706573 |
| lora_4  | 0.591906 | 0.489366 | 0.848887 | 0.702615 |
| lora_8  | 0.600346 | 0.476347 | 0.848355 | 0.693523 |
| lora_16 | 0.583292 | 0.471583 | 0.848447 | 0.709279 |
| lora_32 | 0.577014 | 0.505774 | 0.847235 | 0.696355 |
| lora_64 | 0.594854 | 0.531694 | 0.847471 | 0.733067 |
| full_ft | 0.654125 | 0.58816  | 0.844841 | 0.670931 |

#### From Generalist

| name    |      AIS |      AMG |      Box |    Point |
|:--------|---------:|---------:|---------:|---------:|
| generalist | 0.430989 | 0.357421 | 0.791705 | 0.519416 |
| lora_1  | 0.617624 | 0.539184 | 0.86804  | 0.727741 |
| lora_2  | 0.636927 | 0.531309 | 0.866054 | 0.72443  |
| lora_4  | 0.612037 | 0.555217 | 0.865789 | 0.722931 |
| lora_8  | 0.648352 | 0.564039 | 0.863956 | 0.730869 |
| lora_16 | 0.626368 | 0.559474 | 0.865566 | 0.727721 |
| lora_32 | 0.630273 | 0.562193 | 0.865755 | 0.72731  |
| lora_64 | 0.615694 | 0.572311 | 0.865311 | 0.742754 |
| full_ft | 0.681277 | 0.58494  | 0.854074 | 0.688395 |

### Orgasegment

Domain is highly different from domain ‘known’ by the generalist model

#### From Default
| name    |      AIS |      AMG |      Box |    Point |
|:--------|---------:|---------:|---------:|---------:|
| vanilla | nan        | 0.343003 | 0.630294 | 0.494892 |
| lora_1  | 0.414372 | 0.370126 | 0.767285 | 0.531497 |
| lora_2  | 0.426449 | 0.373112 | 0.770356 | 0.540227 |
| lora_4  | 0.429695 | 0.372823 | 0.76679  | 0.536833 |
| lora_8  | 0.418091 | 0.373189 | 0.769579 | 0.551802 |
| lora_16 | 0.419071 | 0.377984 | 0.773225 | 0.559315 |
| lora_32 | 0.421673 | 0.392801 | 0.77536  | 0.56451  |
| lora_64 | 0.431376 | 0.392141 | 0.77401  | 0.581975 |
| full_ft | 0.481982 | 0.450553 | 0.753868 | 0.568104 |


#### From Generalist

| name    |      AIS |      AMG |      Box |    Point |
|:--------|---------:|---------:|---------:|---------:|
| generalist | 0.239504 | 0.313557 | 0.766814 | 0.426106 |
| lora_1  | 0.467328 | 0.384649 | 0.788527 | 0.526489 |
| lora_2  | 0.471765 | 0.39285  | 0.792983 | 0.536056 |
| lora_4  | 0.455499 | 0.393884 | 0.796325 | 0.536955 |
| lora_8  | 0.451356 | 0.394755 | 0.795676 | 0.537157 |
| lora_16 | 0.476082 | 0.409496 | 0.787012 | 0.534475 |
| lora_32 | 0.471721 | 0.402015 | 0.794801 | 0.550029 |
| lora_64 | 0.474701 | 0.400378 | 0.798804 | 0.555428 |
| full_ft    | 0.504257 | 0.428629 | 0.77399  | 0.56243  |


## LoRA Scaling Factor study on OrgaSegment

Run LoRA finetuning with learning rate 1e-5 on Orgasegment, where $r \in [1, 2, 4, 8, 16, 32, 64]$ and $\alpha \in [1, 2, 4]$

|   alpha |   rank |      ais |   single box |   single point |       ib |       ip |
|--------:|-------:|---------:|-------------:|---------------:|---------:|---------:|
|       1 |      1 | 0.46768  |     0.785293 |       0.439386 | 0.866108 | 0.834264 |
|       1 |      2 | 0.471911 |     0.786374 |       0.433548 | 0.866435 | 0.827245 |
|       1 |      4 | 0.45655  |     0.786528 |       0.425875 | 0.868739 | 0.833975 |
|       1 |      8 | 0.457918 |     0.790174 |       0.46141  | 0.870779 | 0.835133 |
|       1 |     16 | 0.457208 |     0.789676 |       0.466306 | 0.871321 | 0.823999 |
|       1 |     32 | 0.488162 |     0.782712 |       0.448029 | 0.873318 | 0.841033 |
|       1 |     64 | 0.466878 |     0.786976 |       0.472517 | 0.870267 | 0.828985 |
|       2 |      1 | 0.463527 |     0.790652 |       0.436301 | 0.866287 | 0.831002 |
|       2 |      2 | 0.473062 |     0.780874 |       0.420014 | 0.864773 | 0.823518 |
|       2 |      4 | 0.483536 |     0.788871 |       0.458526 | 0.864075 | 0.834208 |
|       2 |      8 | 0.463814 |     0.792031 |       0.449655 | 0.869159 | 0.832825 |
|       2 |     16 | 0.458602 |     0.788588 |       0.471989 | 0.868308 | 0.81852  |
|       2 |     32 | 0.466547 |     0.791587 |       0.472539 | 0.853976 | 0.830419 |
|       2 |     64 | 0.467031 |     0.78799  |       0.475689 | 0.8659   | 0.835546 |
|       4 |      1 | 0.459899 |     0.790665 |       0.438623 | 0.861225 | 0.835481 |
|       4 |      2 | 0.470808 |     0.791318 |       0.430144 | 0.863609 | 0.838067 |
|       4 |      4 | 0.464572 |     0.790739 |       0.464787 | 0.874642 | 0.832083 |
|       4 |      8 | 0.47509  |     0.779162 |       0.461385 | 0.857567 | 0.82316  |
|       4 |     16 | 0.464848 |     0.788842 |       0.472459 | 0.868851 | 0.835807 |
|       4 |     32 | 0.460883 |     0.78711  |       0.469901 | 0.869068 | 0.841081 |
|       4 |     64 | 0.500449 |     0.774742 |       0.447817 | 0.860343 | 0.833205 |

Run LoRA finetuning on OrgaSegment data with $r \in [1, 32], \alpha \in [1, 2, 4]$ and learning rate $\in [1e-3, 5e-4, 1e-4, 5e-5, 1e-5]$

|     lr |   alpha |   rank |      ais |   single box |   single point |       ib |       ip |
|-------:|--------:|-------:|---------:|-------------:|---------------:|---------:|---------:|
| 0.001  |       1 |      1 | 0.442127 |     0.654549 |       0.449638 | 0.71335  | 0.672442 |
| 0.0005 |       1 |      1 | 0.447397 |     0.685428 |       0.474276 | 0.787298 | 0.752919 |
| 0.0001 |       1 |      1 | 0.454513 |     0.781788 |       0.450372 | 0.858663 | 0.818236 |
| 5e-05  |       1 |      1 | 0.449267 |     0.777703 |       0.429012 | 0.850412 | 0.826203 |
| 1e-05  |       1 |      1 | 0.46768  |     0.785293 |       0.439386 | 0.866108 | 0.834264 |
| 0.001  |       1 |     32 | 0.462965 |     0.644866 |       0.447835 | 0.722589 | 0.677151 |
| 0.0005 |       1 |     32 | 0.463994 |     0.71032  |       0.450568 | 0.790268 | 0.761013 |
| 0.0001 |       1 |     32 | 0.450451 |     0.768767 |       0.480264 | 0.852866 | 0.827818 |
| 5e-05  |       1 |     32 | 0.450311 |     0.783481 |       0.451521 | 0.868696 | 0.837526 |
| 1e-05  |       1 |     32 | 0.488162 |     0.782712 |       0.448029 | 0.873318 | 0.841033 |
| 0.001  |       2 |      1 | 0.431478 |     0.672087 |       0.452457 | 0.72659  | 0.691971 |
| 0.0005 |       2 |      1 | 0.45154  |     0.729186 |       0.449041 | 0.818687 | 0.785655 |
| 0.0001 |       2 |      1 | 0.44185  |     0.781901 |       0.47002  | 0.859553 | 0.828746 |
| 5e-05  |       2 |      1 | 0.433222 |     0.785949 |       0.460107 | 0.867836 | 0.836559 |
| 1e-05  |       2 |      1 | 0.463527 |     0.790652 |       0.436301 | 0.866287 | 0.831002 |
| 0.001  |       2 |     32 | 0.464313 |     0.660461 |       0.421702 | 0.733176 | 0.685167 |
| 0.0005 |       2 |     32 | 0.457296 |     0.707891 |       0.456575 | 0.801023 | 0.766612 |
| 0.0001 |       2 |     32 | 0.451915 |     0.766322 |       0.494126 | 0.852293 | 0.819615 |
| 5e-05  |       2 |     32 | 0.45357  |     0.77835  |       0.481603 | 0.863029 | 0.829468 |
| 1e-05  |       2 |     32 | 0.466547 |     0.791587 |       0.472539 | 0.853976 | 0.830419 |
| 0.001  |       4 |      1 | 0.431053 |     0.66506  |       0.454513 | 0.741279 | 0.702872 |
| 0.0005 |       4 |      1 | 0.452152 |     0.718695 |       0.485151 | 0.808962 | 0.777798 |
| 0.0001 |       4 |      1 | 0.453585 |     0.770095 |       0.477717 | 0.847284 | 0.823555 |
| 5e-05  |       4 |      1 | 0.451519 |     0.781282 |       0.472472 | 0.863617 | 0.830746 |
| 1e-05  |       4 |      1 | 0.459899 |     0.790665 |       0.438623 | 0.861225 | 0.835481 |
| 0.001  |       4 |     32 | 0.3129   |     0.634085 |       0.213877 | 0.755184 | 0.663602 |
| 0.0005 |       4 |     32 | 0.458208 |     0.701473 |       0.470512 | 0.799344 | 0.739338 |
| 0.0001 |       4 |     32 | 0.478745 |     0.758938 |       0.495485 | 0.842157 | 0.817848 |
| 5e-05  |       4 |     32 | 0.449575 |     0.777866 |       0.49166  | 0.866549 | 0.831833 |
| 1e-05  |       4 |     32 | 0.460883 |     0.78711  |       0.469901 | 0.869068 | 0.841081 |

Run LoRA finetuning on OrgaSegment data with fixed learning rate and rank and $\alpha \in [0.1, 0.25, 0.5, 0.75, 1, 2, 4]

|    lr |   alpha |   rank |      ais |   single box |   single point |       ib |       ip |
|------:|--------:|-------:|---------:|-------------:|---------------:|---------:|---------:|
| 1e-05 |    0.1  |     32 | 0.469089 |     0.788318 |       0.446878 | 0.866802 | 0.834757 |
| 1e-05 |    0.25 |     32 | 0.453937 |     0.789443 |       0.452305 | 0.864315 | 0.826986 |
| 1e-05 |    0.5  |     32 | 0.465209 |     0.791018 |       0.468178 | 0.868814 | 0.834729 |
| 1e-05 |    0.75 |     32 | 0.456791 |     0.790985 |       0.463087 | 0.870032 | 0.833676 |
| 1e-05 |    1    |     32 | 0.488162 |     0.782712 |       0.448029 | 0.873318 | 0.841033 |
| 1e-05 |    2    |     32 | 0.466547 |     0.791587 |       0.472539 | 0.853976 | 0.830419 |
| 1e-05 |    4    |     32 | 0.460883 |     0.78711  |       0.469901 | 0.869068 | 0.841081 |
